function Taboo(){this._data=[];_.mixin({zipArrays:function(arrays){return _.zip.apply(_,arrays)}});this.metadata={};this._callbacks={};this.addRow=function(row,options){this.addRows([row],options)};this.addRows=function(rows,userOptions){var defaultOptions={printColumnSize:15},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var _this=this;rows.forEach(function(row,index){var currentHeaders=_this.getColumnHeaders();if(_.isArray(row)){row.forEach(function(cell,i){if(i<currentHeaders.length){_this._addCell(currentHeaders[i],cell)}else{}});_this._clean()}else if(_.isObject(row)){var rowHeaders=_.keys(row);_this.addColumns(rowHeaders,{silent:true,ignoreDuplicates:true});_.pairs(row).forEach(function(pair,index){_this._addCell(pair[0],pair[1])});_this._clean()}});if(!options.silent){this.triggerCallbacks("update")}};this.addColumn=function(header,options){this.addColumns([header],options)};this.addColumns=function(headers,userOptions){var defaultOptions={silent:false,ignoreDuplicates:false},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var _this=this,newHeaders;if(options.ignoreDuplicates){newHeaders=_.difference(headers,this.getColumnHeaders())}else{newHeaders=headers}newHeaders.forEach(function(header,index){_this._data.push({header:header,data:[]})});this._clean();if(!options.silent){this.triggerCallbacks("update")}};this.updateWhere=function(update,whereList,userOptions){var defaultOptions={silent:false},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var _this=this,updateHeader=_.keys(update)[0],updateValue=_.values(update)[0],column=_.find(this._data,function(column){return column.header===updateHeader});if(_.isUndefined(column)){return undefined}_.chain(this._getRowsAsCellObjects()).map(function(row,index){var rowUpdate=_.every(_.map(whereList,function(where){return!_.isEmpty(_.where(row,{header:_.keys(where)[0],data:_.values(where)[0]}))}));if(rowUpdate){return index}else{return undefined}}).filter(function(rowIndex){return!_.isUndefined(rowIndex)}).each(function(rowIndex){column.data[rowIndex]=updateValue}).value();if(!options.silent){this.triggerCallbacks("update")}};this.clear=function(userOptions){var defaultOptions={silent:false},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}this._data=[];if(!options.silent){this.triggerCallbacks("update")}};this.getColumnHeaders=function(){return _.map(this._data,function(column){return column.header})};this.getColumn=function(colName){var col;this._data.forEach(function(columnObject,index){if(columnObject.header==colName){col=columnObject.data}});return col};this.getRowAtIndex=function(index,userOptions){var defaultOptions={objects:true},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}if(index>this._data[0]["data"].length){throw"getRowAtIndex(): Index out of range"}var cellObjects=_.map(this._data,function(column,i){return{header:column["header"],data:column["data"][index]}});if(options.objects){return cellObjects}else{return _.pluck(cellObjects,"data")}};this.getRows=function(userOptions){var defaultOptions={objects:true},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}if(!options.objects){return _.chain(this._data).map(function(column){return column.data}).zipArrays().value()}else if(options.objects){return _.chain(this._getRowsAsCellObjects()).map(function(row,index){return _.reduce(row,function(rowObject,cell){var temp={};temp[cell.header]=cell.data;return _.extend(rowObject,temp)},{})}).value()}};this.getRowsWhere=function(whereParams,userOptions){var defaultOptions={objects:true},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var wherePairs=_.pairs(whereParams);return _.chain(this._getRowsAsCellObjects()).filter(function(row){return _.every(_.map(wherePairs,function(whereItem){return!_.isEmpty(_.where(row,{header:whereItem[0],data:whereItem[1]}))}))}).map(function(row,index){if(!options.objects){return _.map(row,function(cell){return cell.data})}else{return _.reduce(row,function(rowObject,cell){var temp={};temp[cell.header]=cell.data;return _.extend(rowObject,temp)},{})}}).value()};this.deleteRowAtIndex=function(index,userOptions){var defaultOptions={silent:false},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var _this=this;_.each(_this._data,function(column,colIndex){column.data.splice(index,1)});if(!options.silent){this.triggerCallbacks("update")}};this.deleteRowsWhere=function(whereParams,userOptions){var defaultOptions={silent:false},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var _this=this;var numberDeleted=_.chain(this._getRowsAsCellObjects()).map(function(row,index){var whereTrue=_.every(_.map(_.pairs(whereParams),function(whereItem){return!_.isEmpty(_.where(row,{header:whereItem[0],data:whereItem[1]}))}));if(whereTrue){return index}else{return undefined}}).filter(function(rowIndex){return!_.isUndefined(rowIndex)}).sort().reverse().each(function(deleteIndex){_this.deleteRowAtIndex(deleteIndex)}).reduce(function(acc,n){return acc+1},0).value();if(!options.silent){this.triggerCallbacks("update")}return numberDeleted};this.columnToObjects=function(colName){var col=_.unique(this.getColumn(colName)),colObjects=_.map(col,function(cell,index){return{name:cell,related:{},_index:index}}),rows=this._getRowsAsCellObjects();colObjects.forEach(function(columnObj,index){rows.forEach(function(row,index){var joinCell=_.find(row,function(cell){return columnObj.name===cell.data});if(typeof joinCell!=="undefined"){var remainingCells=_.reject(row,function(cell){return cell==joinCell});remainingCells.forEach(function(rc){if(typeof columnObj.related[rc.header]==="undefined"){columnObj.related[rc.header]=rc.data}})}else{}})});return colObjects};this.numberOfRows=function(){if(this._data.length===0){return-1}return this._data[0]["data"].length};this.print=function(userOptions){var defaultOptions={printColumnSize:15},options={};if(_.isObject(userOptions)){_.extend(options,defaultOptions,userOptions)}else{options=defaultOptions}var printColumnSize=options.printColumnSize;var printString="\n";var columnLengths=[];if(this._data.length===0){return""}this._data.forEach(function(column){var header=String(column.header);columnLengths.push(Math.max(header.length,printColumnSize));printString+=header+new Array(Math.max(header.length,printColumnSize)-(header.length-1)).join(" ")+" | "});printString+="\n";this._getRowsAsCellObjects().forEach(function(row,rowIndex,array){_.each(row,function(cell,cellIndex){var cellStr=String(cell.data),cellRepr;if(typeof cellStr==="undefined"){cellStr="undefined"}if(cellStr.length>columnLengths[cellIndex]){cellRepr=cellStr.slice(0,columnLengths[cellIndex]-3);cellRepr=cellRepr+"..."}else if(cellStr.length<columnLengths[cellIndex]){var padding=new Array(columnLengths[cellIndex]-(cellStr.length-1)).join(" ");cellRepr=cellStr+padding}else{cellRepr=cellStr}printString+=cellRepr+" | "});printString+="\n"});printString+="\n";return printString};this.leftJoin=function(leftKey,rightTable,rightKey){var left=this,leftHeaders=left.getColumnHeaders(),right=rightTable,joinResult=new Taboo,keyMatchFound,incrementRegex=/(.*-)(\d)/gm;var tablesArray=this._fixInterTableHeaderCollisions(left,right,[rightKey]);left=tablesArray[0];right=tablesArray[1];left._getRowsAsCellObjects().forEach(function(leftRow,index){keyMatchFound=false;var leftKeyValue=_.find(leftRow,function(cell){return cell.header===leftKey});right._getRowsAsCellObjects().forEach(function(rightRow,index,array){var rightKeyValue=_.find(rightRow,function(cell){return cell.header===rightKey});if(_.isEqual(rightKeyValue,leftKeyValue)){var modifiedRightRow=_.reject(rightRow,function(v){return _.isEqual(v,leftKeyValue)});joinResult._addRowCellObjects(leftRow.concat(modifiedRightRow));keyMatchFound=true}if(index===array.length-1&&keyMatchFound==false){joinResult._addRowCellObjects(leftRow)}})});return joinResult};this.innerJoin=function(leftKey,rightTable,rightKey){var left=this,leftHeaders=left.getColumnHeaders(),right=rightTable.clone(),joinResult=new Taboo,keyMatchFound;var tablesArray=this._fixInterTableHeaderCollisions(left,right,[rightKey]);left=tablesArray[0];right=tablesArray[1];left._getRowsAsCellObjects().forEach(function(leftRow,index){keyMatchFound=false;var leftKeyValue=_.find(leftRow,function(cell){return cell.header===leftKey});right._getRowsAsCellObjects().forEach(function(rightRow,index,array){var rightKeyValue=_.find(rightRow,function(cell){return cell.header===rightKey});if(_.isEqual(rightKeyValue,leftKeyValue)){var modifiedRightRow=_.reject(rightRow,function(v){return _.isEqual(v,leftKeyValue)});var newRow=leftRow.concat(modifiedRightRow);joinResult._addRowCellObjects(newRow)}})});return joinResult};this.clone=function(){var data=JSON.parse(JSON.stringify(this._data)),t=new Taboo;t._data=data;return t};this.callbackEventNames=["update"];this.registerCallback=function(eventName,callback){if(_.includes(this.callbackEventNames,eventName)){if(_.isArray(this._callbacks[eventName])){this._callbacks[eventName].push(callback)}else{this._callbacks[eventName]=[callback]}}};this.triggerCallbacks=function(eventName,details){var _this=this;if(_.isArray(this._callbacks[eventName])){this._callbacks[eventName].forEach(function(callback){callback(_this,details)})}};this._clean=function(){var _this=this;var maxColumnLength=_.reduce(this._data,function(memo,value,index){var colLength=value["data"].length;if(colLength>memo){return colLength}else{return memo}},0);this._data.forEach(function(column,index){for(var i=column.data.length;i<maxColumnLength;i++){column.data.push(undefined)}});var incrementRegex=/(.*-)(\d*)/;_.each(_this.getColumnHeaders(),function(header,headerIndex){var remainingHeaders=_this.getColumnHeaders();remainingHeaders.splice(headerIndex,1);while(remainingHeaders.indexOf(header)>=0){var matches=incrementRegex.exec(header);if(matches&&matches.length===3){_this._data[headerIndex].header=header=matches[1]+(Number(matches[2])+1)}else{_this._data[headerIndex].header=header=header+"-1"}}})};this._getRowsAsCellObjects=function(){return _.chain(this._data).map(function(column){return _.map(column.data,function(cell){return{header:column["header"],data:cell}})}).zipArrays().value()};this._addRowCellObjects=function(row){var _this=this;var headers=_.pluck(row,"header");this.addColumns(headers,{silent:true,ignoreDuplicates:true});row.forEach(function(cell){_this._addCell(cell["header"],cell["data"])});this._clean()};this._addCell=function(colName,cellValue){var column=_.find(this._data,function(column){return column.header===colName});column["data"].push(cellValue)};this._fixInterTableHeaderCollisions=function(leftTable,rightTable,exceptions){var incrementRegex=/(.*-)(\d*)/,leftColumnNames=leftTable.getColumnHeaders(),rightColumnNames=rightTable.getColumnHeaders();_.chain(rightColumnNames).map(function(colName){if(_.contains(exceptions,colName)){return colName}while(leftColumnNames.indexOf(colName)>=0){var matches=incrementRegex.exec(colName);if(matches&&matches.length===3){colName=matches[1]+(Number(matches[2])+1)}else{colName=colName+"-1"}}return colName}).each(function(colName,index){rightTable._data[index].header=colName}).value();rightTable._clean();leftTable._clean();return[leftTable,rightTable]}}if(typeof window==="undefined"){var _=require("lodash");module.exports=Taboo}